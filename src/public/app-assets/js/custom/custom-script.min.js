function barraBusqueda(id_barra, id_tabla) {
    let input, filter, table, tr, td, i, txtValue;
    input = document.getElementById(id_barra);

    filter = input.value.toUpperCase();
    table = document.getElementById(id_tabla);
    tr = table.getElementsByTagName("tr");

    for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td");

        if (td) {
            for (let j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().includes(filter)) {
                    tr[i].style.display = "";
                    break;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
}

function mostrarAlumnos(id_gru) {
    $.ajax({
        url: `/getAlumnosGrupo`,
        method: 'POST',
        data: {
            id_gru: id_gru
        },
        success: (alumnos) => {
            let tbody = $('#tabla_alumnos');
            let n = 1;
            tbody.html('');
            alumnos.forEach(alumno => {
                tbody.append(`
                    <tr>
                        <td>${n}</td>
                        <td>${alumno.nom_usu}</td>
                        <td><a href="javascript:void(0);" class="waves-effect waves-teal btn-flat" onclick="eliminarAlumnoGrupo(${alumno.id_ugr}, ${alumno.id_gru}, ${alumno.id_prof})">Eliminar del grupo</a></td>
                    </tr>
                `);
                n++;
            });
        }
    });
}

function eliminarAlumnoGrupo(id_ugr, id_gru, id_prof) {
    $.ajax({
        url: `/deleteAlumnoGrupo`,
        method: 'POST',
        data: {
            id_ugr: id_ugr
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
            mostrarAlumnos(id_gru);
            verGruposProfesor(id_prof);
        }
    });
}

function verGruposProfesor(id_prof) {
    $.ajax({
        url: `/verGruposProfesor`,
        method: 'POST',
        data: {
            id_prof: id_prof
        },
        success: (gruposFin) => {
            let tbody = $('#tabla_grupos');
            tbody.html('');
            gruposFin.forEach(grupo => {
                if (grupo.cla_gru == null) {
                    grupo.cla_gru = '';
                }
                tbody.append(`
                    <tr>
                        <td>${grupo.nom_gru}</td>
                        <td contenteditable="true" id="clave${grupo.id_gru}">${grupo.cla_gru}</td>
                        <td>${grupo.num_alu}</td>
                        <td><a href="javascript:void(0);" class="waves-effect waves-teal btn-flat">Modificar clave</a></td>
                        <td><a href="javascript:void(0);" onclick="mostrarAlumnos(${grupo.id_gru});" class="waves-effect waves-teal btn-flat">Ver alumnado</a></td>
                    </tr>
                `);
            });
        }
    });
}

function modificarClaveGrupo(id_gru, clave) {
    $.ajax({
        url: `/modificarClaveGrupo`,
        method: 'POST',
        data: {
            id_gru: id_gru,
            clave: clave
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
        }
    });
}

function modificarUsuario(id_usu, nom_usu, cor_usu, cat_tus) {
    $.ajax({
        url: `/modificarUsuarioAjax`,
        method: 'POST',
        data: {
            id_usu: id_usu,
            nom_usu: nom_usu,
            cor_usu: cor_usu,
            id_tus: id_tus
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
        }
    });
}

function agregarApoyo(pdf, url, desc, tema) {
    let pd = document.getElementById(pdf).file.filename;
    let ur = document.getElementById(url).value;
    let des = document.getElementById(desc).value;
    let tem = document.getElementById(tema).value;
    $.ajax({
        url: `/agregarApoyo`,
        method: 'POST',
        data: {
            pdf: pd,
            url: ur,
            desc: des,
            tema: tem
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
        }
    });
}

$(() => {
    $("#formuploadajax").on("submit", (e) => {
        e.preventDefault();
        let f = $(this);
        let formData = new FormData(document.getElementById("formuploadajax"));
        //formData.append(f.attr("name"), $(this)[0].files[0]);
        console.log(formData.values());

        $.ajax({
            url: "/agregarApoyo",
            type: "post",
            dataType: "html",
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            success: (response) => {
                M.toast({ html: response, classes: 'rounded' });
            }
        });
    });
});