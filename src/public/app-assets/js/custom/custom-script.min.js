function barraBusqueda(id_barra, id_tabla) {
    let input, filter, table, tr, td, i, txtValue;
    input = document.getElementById(id_barra);

    filter = input.value.toUpperCase();
    table = document.getElementById(id_tabla);
    tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td");

        if (td) {
            for (let j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().includes(filter)) {
                    tr[i].style.display = "";
                    break;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
}


function mostrarAlumnos(id_gru) {
    $.ajax({
        url: `/web/getAlumnosGrupo`,
        method: 'POST',
        data: {
            id_gru: id_gru
        },
        success: (alumnos) => {
            let tbody = $('#tabla_alumnos');
            let n = 1;
            tbody.html('');
            alumnos.forEach(alumno => {
                tbody.append(`
                    <tr>
                        <td>${n}</td>
                        <td>${alumno.nom_usu}</td>
                        <td><a href="javascript:void(0);" class="waves-effect waves-teal btn-flat" onclick="eliminarAlumnoGrupo(${alumno.id_ugr}, ${alumno.id_gru}, ${alumno.id_prof})">Eliminar del grupo</a></td>
                    </tr>
                `);
                n++;
            });
        }
    });
}

function eliminarAlumnoGrupo(id_ugr, id_gru, id_prof) {
    $.ajax({
        url: `/web/deleteAlumnoGrupo`,
        method: 'POST',
        data: {
            id_ugr: id_ugr
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
            mostrarAlumnos(id_gru);
            verGruposProfesor(id_prof);
        }
    });
}

function verGruposProfesor(id_prof) {
    $.ajax({
        url: `/web/verGruposProfesor`,
        method: 'POST',
        data: {
            id_prof: id_prof
        },
        success: (gruposFin) => {
            let tbody = $('#tabla_grupos');
            tbody.html('');
            gruposFin.forEach(grupo => {
                if (grupo.cla_gru == null) {
                    grupo.cla_gru = '';
                }
                tbody.append(`
                    <tr>
                        <td>${grupo.nom_gru}</td>
                        <td contenteditable="true" id="clave${grupo.id_gru}">${grupo.cla_gru}</td>
                        <td>${grupo.num_alu}</td>
                        <td><a href="javascript:void(0);" class="waves-effect waves-teal btn-flat">Modificar clave</a></td>
                        <td><a href="javascript:void(0);" onclick="mostrarAlumnos(${grupo.id_gru});" class="waves-effect waves-teal btn-flat">Ver alumnado</a></td>
                    </tr>
                `);
            });
        }
    });
}

function verGruposProfesor(id_prof) {
    $.ajax({
        url: `/web/verGruposProfesor`,
        method: 'POST',
        data: {
            id_prof: id_prof
        },
        success: (gruposFin) => {
            let tbody = $('#tabla_grupos');
            tbody.html('');
            gruposFin.forEach(grupo => {
                if (grupo.cla_gru == null) {
                    grupo.cla_gru = '';
                }
                tbody.append(`
                    <tr>
                        <td>${grupo.nom_gru}</td>
                        <td contenteditable="true" id="clave${grupo.id_gru}">${grupo.cla_gru}</td>
                        <td>${grupo.num_alu}</td>
                        <td><a href="javascript:void(0);" class="waves-effect waves-teal btn-flat">Modificar clave</a></td>
                        <td><a href="javascript:void(0);" onclick="mostrarAlumnos(${grupo.id_gru});" class="waves-effect waves-teal btn-flat">Ver alumnado</a></td>
                    </tr>
                `);
            });
        }
    });
}

function modificarClaveGrupo(id_gru, clave) {
    $.ajax({
        url: `/web/modificarClaveGrupo`,
        method: 'POST',
        data: {
            id_gru: id_gru,
            clave: clave
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
        }
    });
}

function modificarUsuario(id_usu, nom_usu, cor_usu) {
    $.ajax({
        url: `/web/modificarUsuarioAjax`,
        method: 'POST',
        data: {
            id_usu: id_usu,
            nom_usu: nom_usu,
            cor_usu: cor_usu
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
        }
    });
}

function eliminarUsuario(id_usu) {
    $.ajax({
        url: `/web/eliminarUsuarioAjax`,
        method: 'POST',
        data: {
            id_usu: id_usu
        },
        success: (response) => {
            M.toast({ html: response, classes: 'rounded' });
            mostrarUsuarios(id_usu);
        }
    });
}

function mostrarUsuarios(id_usu) {
    $.ajax({
        url: `/web/getUsuariosAjax`,
        method: 'POST',
        data: {
            id_usu: id_usu
        },
        success: (ListaFinal) => {
            console.log(ListaFinal);
            let tbody = $('#tabla_usu');
            let valor;
            tbody.html('');
            ListaFinal.forEach(usuario => {
                console.log(usuario.nom_usu);
                if (usuario.id_tus == 1) {
                    valor = "Alumno";
                } else if (usuario.id_tus == 2) {
                    valor = "Tutor";
                } else if (usuario.id_tus == 3) {
                    valor = "Profesor";
                } else if (usuario.id_tus == 4) {
                    valor = "Autoridad";
                } else {
                    valor = "Administrador";
                }
                tbody.append(`
                        <tr>
                       
                            <td contenteditable="true" id="nom_usu${usuario.id_usu}">${usuario.nom_usu}</td>
                            <td contenteditable="true" id="clave${usuario.id_usu}">${usuario.cor_usu}</td>
                            <td>${valor}</td>
                            <td>
                            <a href="javascript:void(0);" onclick="modificarUsuario({{id_usu}}, document.getElementById('nom_usu{{id_usu}}').innerText,document.getElementById('cor_usu{{id_usu}}').innerText);" class="waves-effect waves-teal btn-flat">Modificar</a>
                            </td>
                            <td>
                            <a href="javascript:void(0);" onclick="eliminarUsuario({{id_usu}});" class="waves-effect waves-teal btn-flat">Eliminar</a>
                            </td>
                        </tr>
                `);

            });
        }
    });
}

$(() => {
    $("#formuploadajax").on("submit", (e) => {
        e.preventDefault();
        let formData = new FormData(document.getElementById("formuploadajax"));
        //formData.append(f.attr("name"), $(this)[0].files[0]);
        $.ajax({
            url: "/web/insertarApoyo",
            method: 'POST',
            data: formData,
            cache: false,
            contentType: false,
            processData: false
        }).done(function(res) {
            M.toast({ html: res, classes: 'rounded' });
            mostrarApoyos(-1);
        });
    });
    $('#modificar_apoyo_ventana').on("submit", (e) => {
        e.preventDefault();
        let formData = new FormData(document.getElementById('modificar_apoyo_ventana'));
        formData.append('link', document.getElementById('url_ventana_muestra').textContent);
        $.ajax({
            url: "/web/updateApoyo",
            method: 'POST',
            data: formData,
            cache: false,
            contentType: false,
            processData: false
        }).done((res) => {
            M.toast({ html: res.aviso, classes: 'rounded' });
            mostrarApoyos(-1);
            setVentanaApoyos(res.pdf, res.url, res.tema, res.id);
        });
    });
});

function mostrarApoyos(id_tem) {
    $.ajax({
        url: '/web/getApoyosAjax',
        method: 'POST',
        data: {
            id_tem: id_tem
        }
    }).done((apoyos) => {
        let contenedor = $('#div_contenedor_apoyos');
        contenedor.html('');
        apoyos.forEach(apoyo => {
            contenedor.append(`
            <div class="col xl3 l6 m3 s6" style="height: 250px;">
                <div class="card box-shadow-none mb-1 app-file-info">
                    <div class="card-content">
                        <div class="app-file-content-logo grey lighten-4" onclick="setVentanaApoyos('${apoyo.nom_pdf}','${apoyo.vin_apo}','${apoyo.nom_tem}');
                        document.getElementById('show').className = 'app-file-overlay show';
                        document.getElementById('show2').className = 'app-file-sidebar-info ps show'">
                            <div class="fonticon">
                                <i class="material-icons">more_vert</i>
                            </div>
                            <img class="recent-file" src="/app-assets/images/icon/pdf.png" height="38" width="30" alt="Card image cap">
                        </div>
                        <div class="app-file-details">
                            <div class="app-file-name font-weight-700">${apoyo.nom_tem}</div>
                            <div class="app-file-size">${apoyo.nom_pdf}</div>
                        </div>
                    </div>
                </div>
            </div>
            `);
        });
    });
}

function setVentanaApoyos(pdf, url, tema, id) {
    document.getElementById('pdf_ventana_muestra').textContent = pdf;
    document.getElementById('url_ventana_muestra').textContent = url;
    document.getElementById('tema_ventana_muestra').textContent = tema;
    document.getElementById('id_apoyo').value = id;
    $('#btn_delete_ventana_apoyos').click(() => {
        deleteApoyo(id);
    });
}


function deleteApoyo(id) {
    $.ajax({
        url: '/web/deleteApoyoAjax',
        method: 'POST',
        data: {
            id_apoyo: id
        }
    }).done((res) => {
        M.toast({ html: res, classes: 'rounded' });
        document.getElementById('show').className = 'app-file-overlay';
        document.getElementById('show2').className = 'app-file-sidebar-info ps';
        mostrarApoyos(-1);

    });
}

function obtenerAlumnos(id_gru) {
    $.ajax({
        url: '/web/getAlumnosGrupo',
        method: 'POST',
        data: {
            id_gru
        },
        success: (res) => {
            let array = [];
            res.forEach(alumno => {
                array.push([alumno.id_ugr, alumno.nom_usu]);
                if (res.indexOf(alumno) == (res.length - 1)) {
                    crearSelectMaterialize(array, 'alumnosSeleccionados');
                }
            });
        }
    });
}


function crearSelect(arreglo, tituloGeneral, id_contenedor) {
    generarToken((token) => {
        let div1 = document.createElement('div');
        div1.className = 'select-wrapper';
        let input1 = document.createElement('input');
        input1.className = 'select-dropdown dropdown-trigger';
        input1.type = 'text';
        input1.readOnly = "true";
        input1.setAttribute('data-target', `select-options-8b3b1920-466c-8ceb-0a56-b222be481a17`);
        div1.appendChild(input1);
        let ul1 = document.createElement('ul');
        ul1.id = `select-options-8b3b1920-466c-8ceb-0a56-b222be481a17`;
        ul1.className = 'dropdown-content select-dropdown';
        ul1.tabIndex = 0;
        ul1.style = '';
        let ligeneral = document.createElement('li');
        ligeneral.className = 'selected';
        ligeneral.tabIndex = 0;
        ligeneral.id = `select-options-8b3b1920-466c-8ceb-0a56-b222be481a170`
        let spangeneral = document.createElement('span');
        spangeneral.textContent = tituloGeneral;
        ligeneral.appendChild(spangeneral);
        ul1.appendChild(ligeneral);
        let select = document.createElement('select');
        let option1 = document.createElement('option');
        option1.value = -1;
        option1.textContent = tituloGeneral;
        select.appendChild(option1);
        select.tabIndex = -1;
        let n = 1;
        arreglo.forEach(elemento => {
            let li = document.createElement('li');
            li.tabIndex = 0;
            li.id = `select-options-8b3b1920-466c-8ceb-0a56-b222be481a17${n}`
            let span = document.createElement('span');
            span.textContent = elemento[1];
            li.appendChild(span);
            ul1.appendChild(li);

            let option = document.createElement('option');
            option.value = elemento[0];
            option.textContent = elemento[1];
            select.appendChild(option);
            n++;
        });
        let svg = document.createElement('svg');
        svg.className = 'caret';
        svg.height = 24;
        svg.viewBox = "0 0 24 24";
        svg.width = 24;
        svg.xmlns = 'http://www.w3.org/2000/svg';
        let rect = SVG('<svg class="caret" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg>').addTo(div1);
        let path1 = document.createElement('path');
        path1.d = 'M7 10l5 5 5-5z';
        let path2 = document.createElement('path');
        path2.d = 'M0 0h24v24H0z';
        path2.fill = 'none';
        svg.appendChild(path1);
        svg.appendChild(path2);
        div1.appendChild(ul1);
        div1.appendChild(select);
        document.getElementById(id_contenedor).appendChild(div1);
    });

}

function crearSelectMaterialize(arreglo, id_select) {
    arreglo.forEach(elemento => {
        $(`#${id_select}`).append($('<option>', {
            value = elemento[0],
            text = elemento[1]
        }));
        if (arreglo.indexOf(elemento) == (arreglo.length - 1)) {
            $(`#${id_select}`).formSelect();
        }
    });
}